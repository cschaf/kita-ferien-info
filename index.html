<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferienplan 2025</title> <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for light mode */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            color: #374151; /* Default text color */
            min-height: 100vh; /* Ensure body takes at least full viewport height */
            display: flex; /* Use flexbox for overall layout to push footer down */
            flex-direction: column; /* Stack content vertically */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for dark mode */
            padding-bottom: 8rem; /* Increased padding to allow scrolling past the sticky bar on mobile */
        }
        .main-container {
            flex-grow: 1; /* Allow main content to grow and push footer down */
            max-width: 4xl; /* Tailwind max-width-4xl */
            margin-left: auto;
            margin-right: auto;
            padding: 1rem; /* p-4 */
            padding-top: 2rem; /* md:p-8, lg:p-12 */
            padding-bottom: 2rem; /* md:p-8, lg:p-12 */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .main-container {
                padding: 2rem; /* md:p-8 */
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .main-container {
                padding: 3rem; /* lg:p-12 */
            }
        }

        .card {
            background-color: #ffffff;
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Softer shadow */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease-in-out; /* Smooth transition for past-card effect */
            border: 1px solid transparent; /* Default transparent border */
        }
        /* Header Section - Adjusted for Dark Mode Toggle Button */
        .header-section {
            background-color: #4f46e5; /* Indigo */
            color: #ffffff;
            padding: 2rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative; /* Needed for absolute positioning of the toggle button */
            display: flex; /* Use flexbox for alignment */
            flex-direction: column; /* Stack content vertically by default */
            align-items: center; /* Center items horizontally */
            justify-content: center; /* Center items vertically */
        }
        .header-content {
            /* This div will wrap the title and paragraph to keep them together */
            text-align: center;
            flex-grow: 1; /* Allow content to take available space */
            /* Ensure header content has some top padding if controls are absolutely positioned */
            padding-top: 0.5rem;
        }

        /* Language Switcher Container - now positioned by its wrapper */
        #languageSwitcherContainer {
            /* position: absolute; top/right/z-index removed */
            /* Tailwind classes 'relative inline-block text-left' still apply from HTML */
        }

        /* Language Switcher Dropdown Menu */
        #language-menu {
            z-index: 40; /* Ensures dropdown is above other header controls */
        }

        /* Styles for the wrapper of header controls (lang switcher, dark mode toggle) */
        .header-controls-wrapper {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            z-index: 30;
        }

        @media (min-width: 640px) { /* sm breakpoint or higher */
            .header-controls-wrapper {
                top: 0.75rem;
                right: 0.75rem;
                gap: 0.5rem;
            }
            #languageSwitcherContainer #language-menu-button { /* Restore some padding for larger lang button */
                padding-left: 0.75rem; /* px-3 */
                padding-right: 0.75rem; /* px-3 */
            }
             #languageSwitcherContainer #language-menu-button img {
                margin-right: 0.5rem; /* mr-2 */
            }
            #languageSwitcherContainer #language-menu-button .fa-chevron-down {
                margin-left: 0.5rem; /* ml-2 */
            }
        }
        /* Ensure header-content is relatively positioned for z-index stacking */
        .header-content {
            position: relative;
            z-index: 5; /* Lower than header-controls-wrapper */
        }

        .section-title {
            color: #4f46e5; /* Indigo for section titles */
            font-weight: 700; /* Bold */
            margin-bottom: 1rem;
            border-bottom: 2px solid #e0e7ff; /* Light indigo border */
            padding-bottom: 0.5rem;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .list-item {
            margin-bottom: 0.5rem;
            display: flex; /* Use flexbox */
            flex-direction: column; /* Always stack items vertically */
            align-items: flex-start; /* Align content to the start (left) */
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 0.25rem; /* Reduced gap between text and button */
            list-style-type: disc; /* Ensure regular list items have bullets */
        }
        .list-item strong {
            color: #374151; /* Darker gray for strong text */
            transition: color 0.3s ease;
        }
        /* Styling for highlighted deadline items */
        .deadline-highlight {
            background-color: #fff7ed; /* Very light orange/yellow background */
            border-left: 4px solid #f97316; /* Orange border */
            padding: 0.75rem 1rem; /* More padding */
            border-radius: 8px; /* Rounded corners */
            margin-top: 0.75rem; /* Space from previous item */
            margin-bottom: 0.75rem; /* Space to next item */
            display: flex; /* Keep flex for content alignment */
            flex-direction: column; /* Always stack items vertically */
            align-items: flex-start; /* Align content to the start (left) */
            flex-wrap: wrap;
            gap: 0.25rem;
            list-style-type: none; /* Remove bullet point */
            /* Adjust padding-left to align with other list items that have pl-5 (1.25rem) */
            padding-left: calc(1rem + 1.25rem); /* Base padding + ul's padding */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .deadline-highlight strong {
            color: #dc2626;
            font-weight: 800;
            font-size: 1.05rem;
            transition: color 0.3s ease;
        }
        /* Combined Note and Disclaimer Section */
        .note-disclaimer-section {
            background-color: #fff7ed;
            border-left: 5px solid #f97316;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 2rem;
            margin-bottom: 2rem;
            color: #374151;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .note-disclaimer-section p {
            margin-bottom: 0.5rem;
        }
        .note-disclaimer-section .disclaimer-text {
            font-size: 0.875rem;
            color: #6b7280;
            text-align: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .note-disclaimer-section .note-title {
            color: #dc2626;
            font-weight: 800;
            transition: color 0.3s ease;
        }


        .calendar-button {
            flex-shrink: 0;
            background-color: #e0e7ff;
            color: #4f46e5;
            font-weight: 500;
            padding: 0.3rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            border: 1px solid #c7d2fe;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, color 0.2s ease-in-out;
            white-space: nowrap;
            margin-top: 0.5rem;
            align-self: flex-start;
        }
        .calendar-button:hover {
            background-color: #c7d2fe;
            border-color: #a5b4fc;
        }
        .calendar-button i {
            margin-right: 0.25rem;
        }


        /* Styling for past event cards */
        .past-card {
            background-color: #e9ecef;
            color: #6c757d;
            opacity: 0.7;
            box-shadow: none;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease-in-out;
        }
        .past-card .section-title,
        .past-card .list-item strong {
            color: #6c757d;
            transition: color 0.3s ease;
        }
        .past-card .deadline-highlight strong {
            color: #868e96;
            transition: color 0.3s ease;
        }
        .past-card .calendar-button {
            background-color: #ced4da;
            color: #495057;
            border-color: #adb5bd;
            cursor: default;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .past-card .calendar-button:hover {
            background-color: #adb5bd;
            border-color: #6c757d;
        }
        .past-card .deadline-highlight {
            background-color: #e9ecef;
            border-left-color: #adb5bd;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        /* Styling for current event card */
        .current-card {
            border: 2px solid #10b981;
            background-color: #ecfdf5;
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.2);
            opacity: 1;
            transition: all 0.3s ease-in-out;
        }
        .current-card .section-title {
            color: #059669;
            transition: color 0.3s ease;
        }
        .current-card .list-item strong {
            color: #065f46;
            transition: color 0.3s ease;
        }

        /* Styling for upcoming event card */
        .upcoming-card {
            border: 2px solid #3b82f6;
            background-color: #e0f2fe;
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.2);
            opacity: 1;
            transition: all 0.3s ease-in-out;
        }
        .upcoming-card .section-title {
            color: #1d4ed8;
            transition: color 0.3s ease;
        }
        .upcoming-card .list-item strong {
            color: #1e40af;
            transition: color 0.3s ease;
        }

        /* Filter and Sort Controls */
        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }
        .controls-container label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
            transition: color 0.3s ease;
        }
        .controls-container select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: #f9fafb;
            font-size: 1rem;
            color: #4b5563;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .controls-container select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .controls-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .controls-right-aligned {
            display: flex;
            justify-content: flex-end;
            width: 100%;
        }
        .controls-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #4f46e5;
            flex-grow: 1;
            transition: color 0.3s ease;
        }

        @media (min-width: 640px) {
            .controls-container .collapsible-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 1rem;
            }
            .controls-group {
                flex-direction: row;
                align-items: center;
                gap: 1rem;
            }
            .controls-group > div {
                flex: 1;
            }
            .controls-right-aligned {
                width: auto;
            }
        }

        /* Print Button Styling */
        .print-button-container {
            display: flex;
            justify-content: center;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            transition: margin 0.3s ease;
        }
        .print-button {
            background-color: #10b981;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .print-button:hover {
            background-color: #059669;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .print-button i {
            margin-right: 0.5rem;
        }

        /* Legend Styling */
        .legend-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }
        .legend-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #4f46e5;
            flex-grow: 1;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #4b5563;
            transition: color 0.3s ease;
        }
        .color-box {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .past-color {
            background-color: #e9ecef;
            border-color: #dee2e6;
        }
        .current-color {
            background-color: #ecfdf5;
            border-color: #10b981;
        }
        .upcoming-color {
            background-color: #e0f2fe;
            border-color: #3b82f6;
        }
        .deadline-color {
            background-color: #fff7ed;
            border-color: #f97316;
        }
        .legend-icon {
            color: #4f46e5;
            font-size: 1.25rem;
            transition: color 0.3s ease;
        }

        @media (max-width: 639px) {
            .legend-items {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
        }

        /* Footer Styling */
        .footer-section {
            margin-top: 0.5rem;
            padding: 2rem 1.5rem;
            background-color: #374151;
            color: #d1d5db;
            text-align: center;
            border-radius: 12px;
            font-size: 0.875rem;
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .footer-section p {
            margin-bottom: 0.5rem;
        }
        .footer-section a {
            color: #a5b4fc;
            text-decoration: underline;
            transition: color 0.3s ease;
        }
        .footer-section a:hover {
            color: #c7d2fe;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        body.dark-mode .card {
            background-color: #2d3748;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: #4a5568;
        }
        body.dark-mode .header-section {
            background-color: #4338ca;
            color: #ffffff;
        }
        body.dark-mode .section-title {
            color: #9f7aea;
            border-bottom-color: #4a5568;
        }
        body.dark-mode .list-item strong {
            color: #e2e8f0;
        }
        body.dark-mode .deadline-highlight {
            background-color: #4a2f00;
            border-left-color: #f97316;
        }
        body.dark-mode .deadline-highlight strong {
            color: #ef4444;
        }
        body.dark-mode .note-disclaimer-section {
            background-color: #4a2f00;
            border-left-color: #f97316;
            color: #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .note-disclaimer-section .disclaimer-text {
            color: #a0aec0;
            border-top-color: #4a5568;
        }
        body.dark-mode .note-disclaimer-section .note-title {
            color: #ef4444;
        }
        body.dark-mode .calendar-button {
            background-color: #6366f1;
            color: #ffffff;
            border-color: #4f46e5;
        }
        body.dark-mode .calendar-button:hover {
            background-color: #4f46e5;
            border-color: #3730a3;
        }

        /* Dark mode for past cards */
        body.dark-mode .past-card {
            background-color: #374151;
            color: #a0aec0;
            opacity: 0.8;
            border-color: #4a5568;
        }
        body.dark-mode .past-card .section-title,
        body.dark-mode .past-card .list-item strong {
            color: #a0aec0;
        }
        body.dark-mode .past-card .deadline-highlight strong {
            color: #cbd5e0;
        }
        body.dark-mode .past-card .calendar-button {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #6b7280;
        }
        body.dark-mode .past-card .calendar-button:hover {
            background-color: #6b7280;
            border-color: #4a5568;
        }
        body.dark-mode .past-card .deadline-highlight {
            background-color: #374151;
            border-left-color: #6b7280;
        }

        /* Dark mode for current card */
        body.dark-mode .current-card {
            border-color: #10b981;
            background-color: #166534;
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }
        body.dark-mode .current-card .section-title {
            color: #34d399;
        }
        body.dark-mode .current-card .list-item strong {
            color: #a7f3d0;
        }

        /* Dark mode for upcoming card */
        body.dark-mode .upcoming-card {
            border-color: #3b82f6;
            background-color: #1e3a8a;
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }
        body.dark-mode .upcoming-card .section-title {
            color: #60a5fa;
        }
        body.dark-mode .upcoming-card .list-item strong {
            color: #93c5fd;
        }

        /* Dark mode for controls */
        body.dark-mode .controls-container {
            background-color: #2d3748;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .controls-container label {
            color: #e2e8f0;
        }
        body.dark-mode .controls-container select {
            border-color: #4a5568;
            background-color: #4a5568;
            color: #e2e8f0;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%23e2e8f0' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
        }
        body.dark-mode .controls-container select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }
        body.dark-mode .controls-title {
            color: #9f7aea;
        }

        /* Dark mode for print button */
        body.dark-mode .print-button-container .print-button {
            background-color: #059669;
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .print-button-container .print-button:hover {
            background-color: #047857;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Dark mode for legend */
        body.dark-mode .legend-container {
            background-color: #2d3748;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .legend-title {
            color: #9f7aea;
        }
        body.dark-mode .legend-item {
            color: #e2e8f0;
        }
        body.dark-mode .color-box {
            border-color: #4a5568;
        }
        body.dark-mode .legend-icon {
            color: #9f7aea;
        }
        body.dark-mode .past-color {
            background-color: #374151;
            border-color: #4a5568;
        }
        body.dark-mode .current-color {
            background-color: #166534;
            border-color: #10b981;
        }
        body.dark-mode .upcoming-color {
            background-color: #1e3a8a;
            border-color: #3b82f6;
        }
        body.dark-mode .deadline-color {
            background-color: #4a2f00;
            border-color: #f97316;
        }

        /* Dark mode for footer */
        body.dark-mode .footer-section {
            background-color: #111827;
            color: #a0aec0;
            border-top: 2px solid #374151;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .footer-section a {
            color: #c7d2fe;
        }
        body.dark-mode .footer-section a:hover {
            color: #a5b4fc;
        }

        /* Styles for #darkModeToggle - ensuring it works within the flex wrapper */
        /* Most appearance is handled by Tailwind classes on the button element itself */
        #darkModeToggle {
            /* Example: ensure consistent size if needed, though Tailwind classes are preferred */
            /* width: 2.5rem; height: 2.5rem; */ /* e.g. w-10 h-10 */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            /* The Tailwind classes p-2, rounded-full, text-white etc. will style it */
        }
        /* Icon styling within the dark mode toggle, if not fully handled by Tailwind */
        #darkModeToggle .fas {
            /* font-size: 1.25rem; /* text-xl -- this is on the HTML element */
            /* color: #ffffff; /* text-white -- this is on the HTML element */
        }
        body.dark-mode #darkModeToggle .fas {
            /* color: #e2e8f0; /* Ensure icon is visible in dark mode if needed */
        }


        /* Strikethrough style for past items */
        .line-through {
            text-decoration: line-through;
            color: #6c757d;
            transition: color 0.3s ease;
        }
        body.dark-mode .line-through {
            color: #a0aec0;
        }

        /* Scroll to Top Button */
        .scroll-to-top-btn {
            position: fixed;
            bottom: 9rem;
            right: 2rem;
            background-color: #4f46e5;
            color: #ffffff;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
            z-index: 1001;
            transform: translateY(100px);
        }
        .scroll-to-top-btn.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        .scroll-to-top-btn:hover {
            background-color: #4338ca;
            transform: translateY(-3px);
        }

        /* Dark Mode for Scroll to Top Button */
        body.dark-mode .scroll-to-top-btn {
            background-color: #6366f1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        body.dark-mode .scroll-to-top-btn:hover {
            background-color: #4f46e5;
        }

        /* New styles for collapsible sections */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e0e7ff;
            margin-bottom: 1rem;
        }
        body.dark-mode .collapsible-header {
            border-bottom-color: #4a5568;
        }

        .collapsible-header .toggle-button {
            background: none;
            border: none;
            color: #4f46e5;
            cursor: pointer;
            font-size: 1.25rem;
            transition: transform 0.3s ease-in-out, color 0.3s ease;
            padding: 0.25rem;
            border-radius: 50%;
            width: 2.25rem;
            height: 2.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .collapsible-header .toggle-button:hover {
            background-color: rgba(79, 70, 229, 0.1);
        }
        body.dark-mode .collapsible-header .toggle-button {
            color: #9f7aea;
        }
        body.dark-mode .collapsible-header .toggle-button:hover {
            background-color: rgba(159, 122, 234, 0.2);
        }

        .collapsible-header .toggle-button.expanded i {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
            opacity: 0;
            pointer-events: none;
        }
        .collapsible-content.expanded {
            max-height: 500px;
            opacity: 1;
            pointer-events: auto;
        }


        /* Print-specific styles */
        @media print {
            body {
                background-color: #ffffff;
                color: #000000;
                margin: 0;
                padding: 0;
                padding-bottom: 0 !important;
            }
            .main-container {
                padding: 1cm;
                max-width: none;
                width: 100%;
            }
            .header-section,
            .controls-container,
            .collapsible-header,
            .calendar-button,
            .note-disclaimer-section,
            .legend-container,
            .footer-section,
            .dark-mode-toggle,
            .scroll-to-top-btn,
            .print-button-container,
            .sticky-countdown-bar {
                display: none !important;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                margin-bottom: 1rem;
                padding: 1rem;
                opacity: 1 !important;
                color: #000000 !important;
                background-color: #ffffff !important;
                /* Prevent card from breaking across pages */
                page-break-inside: avoid;
            }
            .card .section-title,
            .card .list-item strong,
            .card .deadline-highlight strong {
                color: #000000 !important;
            }
            .card.past-card {
                opacity: 1 !important;
                background-color: #f8f9fa !important;
                border-color: #e9ecef !important;
            }
            .card.current-card,
            .card.upcoming-card {
                border-color: #000000 !important;
            }
            .list-item, .deadline-highlight {
                padding-left: 0;
                margin-bottom: 0.25rem;
            }
            ul {
                padding-left: 1.5rem;
            }
        }
        /* Mobile-specific adjustment */
        @media (max-width: 639px) {
            /* .dark-mode-toggle specific styles are now part of its main rule or handled by wrapper */
            .header-content {
                padding-top: 3.5rem;
                padding-right: 0.5rem;
                padding-left: 0.5rem;
            }
            /* Adjustments for language switcher and dark mode toggle within the wrapper on small screens */
            .header-controls-wrapper {
                /* top/right/gap already defined for mobile in the main rule */
            }
            #languageSwitcherContainer #language-menu-button {
                padding-left: 0.5rem; /* Tailwind px-2 */
                padding-right: 0.5rem; /* Tailwind px-2 */
                padding-top: 0.25rem; /* Tailwind py-1 */
                padding-bottom: 0.25rem; /* Tailwind py-1 */
                font-size: 0.75rem; /* Tailwind text-xs */
            }
            #languageSwitcherContainer #language-menu-button img {
                width: 0.875rem; /* Tailwind w-3.5 */
                margin-right: 0.25rem; /* Tailwind mr-1 */
            }
             #languageSwitcherContainer #language-menu-button .fa-chevron-down {
                margin-left: 0.25rem; /* Tailwind ml-1 */
                width: 0.75rem; /* Tailwind w-3 */
                height: 0.75rem; /* Tailwind h-3 */
            }
            #languageSwitcherContainer #language-menu {
                width: 10rem; /* Adjust width of dropdown menu for smaller screens */
            }
            #languageSwitcherContainer #language-menu a {
                padding: 0.5rem 0.75rem; /* Adjust item padding */
                font-size: 0.75rem; /* Adjust item font size */
            }
            #languageSwitcherContainer #language-menu img {
                width: 0.875rem; /* Adjust flag size in menu */
                margin-right: 0.5rem;
            }
        }

        /* Sticky Countdown Bar Styling */
        .sticky-countdown-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #667eea;
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            text-align: center;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            font-size: 0.95rem;
        }
        .sticky-countdown-bar .countdown-combined-display {
            font-weight: 600;
            line-height: 1.4;
        }
        @media (min-width: 768px) {
            .sticky-countdown-bar {
                padding: 0.75rem 2rem;
                font-size: 1.1rem;
            }
        }

        /* Dark Mode for Sticky Countdown Bar */
        body.dark-mode .sticky-countdown-bar {
            background-color: #4338ca;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4);
            color: #ffffff;
        }
    </style>
</head>
<body class="p-4 md:p-8 lg:p-12">
<div class="main-container">
    <header class="header-section">
        <div class="header-controls-wrapper">
            <!-- Language Switcher Dropdown -->
            <div id="languageSwitcherContainer" class="relative inline-block text-left"> <!-- Removed inline style, will be handled by CSS block -->
                <!-- Restored Button HTML -->
                <button id="language-menu-button" type="button" class="inline-flex items-center justify-center w-full rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-3 py-2 bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-expanded="false" aria-haspopup="true">
                    <img id="current-flag-image" src="images/flags/de.svg" alt="Flag" class="w-5 h-auto mr-2">
                    <span id="current-language-name" class="hidden sm:inline">Deutsch</span>
                    <i class="fas fa-chevron-down -mr-1 ml-2 h-5 w-5 text-gray-400"></i>
                </button>
                <!-- End Restored Button HTML -->
                <div class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" aria-labelledby="language-menu-button" id="language-menu">
                    <div class="py-1" role="none">
                        <!-- Dropdown items will be populated by JavaScript if needed, or can be static HTML if content is fixed -->
                        <a href="#" class="flex items-center text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" id="lang-de" data-lang-code="de">
                            <img src="images/flags/de.svg" alt="DE Flag" class="w-5 h-auto mr-3"> Deutsch
                        </a>
                        <a href="#" class="flex items-center text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" id="lang-en" data-lang-code="en">
                            <img src="images/flags/gb.svg" alt="GB Flag" class="w-5 h-auto mr-3"> English
                        </a>
                        <a href="#" class="flex items-center text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" id="lang-ar" data-lang-code="ar">
                            <img src="images/flags/sa.svg" alt="SA Flag" class="w-5 h-auto mr-3"> العربية
                        </a>
                        <a href="#" class="flex items-center text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" id="lang-tr" data-lang-code="tr">
                            <img src="images/flags/tr.svg" alt="TR Flag" class="w-5 h-auto mr-3"> Türkçe
                        </a>
                        <a href="#" class="flex items-center text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" id="lang-pl" data-lang-code="pl">
                            <img src="images/flags/pl.svg" alt="PL Flag" class="w-5 h-auto mr-3"> Polski
                        </a>
                        <a href="#" class="flex items-center text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" id="lang-ru" data-lang-code="ru">
                            <img src="images/flags/ru.svg" alt="RU Flag" class="w-5 h-auto mr-3"> Русский
                        </a>
                    </div>
                </div>
            </div>
            <button id="darkModeToggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <div class="header-content">
            <h1 id="mainTitle" class="text-3xl md:text-4xl font-bold mb-2">Ferienplan 2025</h1>
            <p class="text-lg md:text-xl">Übersicht über Ferienzeiten und Schließtage der Kita</p>
        </div>
    </header>

    <div class="note-disclaimer-section">
        <p class="font-semibold text-lg mb-2 note-title">Wichtiger Hinweis zur Anmeldung:</p>
        <p>Die Anmeldung für die Feriendienste erfolgt ausschließlich im Büro – persönlich, telefonisch oder per Mail!</p>
        <p class="disclaimer-text">Alle Angaben ohne Gewähr.</p>
    </div>

    <div class="legend-container">
        <div class="collapsible-header">
            <h2 class="legend-title">Legende</h2>
            <button class="toggle-button" data-target="legend-content" aria-expanded="false" aria-controls="legend-content">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div id="legend-content" class="collapsible-content">
            <div class="legend-items">
                <div class="legend-item">
                    <span class="color-box past-color"></span>
                    <span>Vergangene Termine</span>
                </div>
                <div class="legend-item">
                    <span class="color-box current-color"></span>
                    <span>Aktuelle Termine</span>
                </div>
                <div class="legend-item">
                    <span class="color-box upcoming-color"></span>
                    <span>Nächste kommende Termine</span>
                </div>
                <div class="legend-item">
                    <span class="color-box deadline-color"></span>
                    <span>Wichtiger Hinweis</span>
                </div>
                <div class="legend-item">
                    <i class="fas fa-calendar-plus legend-icon"></i>
                    <span>Kalender-Eintrag hinzufügen</span>
                </div>
            </div>
        </div>
    </div>

    <div class="controls-container">
        <div class="collapsible-header">
            <h2 class="controls-title">Filter & Sortierung</h2>
            <button class="toggle-button" data-target="controls-content" aria-expanded="false" aria-controls="controls-content">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div id="controls-content" class="collapsible-content">
            <div class="controls-group">
                <div>
                    <label for="yearSelector">Jahr:</label>
                    <select id="yearSelector"></select>
                </div>
                <div>
                    <label for="filterOptions">Filter:</label>
                    <select id="filterOptions">
                        <option value="all">Alle Termine</option>
                        <option value="upcoming">Nur kommende Termine</option>
                    </select>
                </div>
                <div>
                    <label for="sortOptions">Sortierung:</label>
                    <select id="sortOptions">
                        <option value="asc">Älteste zuerst</option>
                        <option value="desc">Neueste zuerst</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <main id="cards-container">
    </main>

    <div class="print-button-container">
        <button class="print-button" onclick="window.print()">
            <i class="fas fa-print"></i> Drucken
        </button>
    </div>
</div>

<div id="stickyCountdownBar" class="sticky-countdown-bar">
    <span id="countdownCombinedDisplay" class="countdown-combined-display"></span>
</div>

<footer class="footer-section">
    <p>Dies ist ein privates Projekt und steht in keiner direkten Verbindung zur Kita.</p>
    <p>Die Informationen auf dieser Seite wurden allgemein von der Kita an alle verteilt.</p>
    <p>Ich habe nicht mehr Informationen als alle anderen auch. Alle Angaben sind ohne Gewähr.</p>
    <p>
        <a href="images/2025-Ferien.jpg" target="_blank" rel="noopener noreferrer">
            Link zur originalen Liste mit den Terminen (JPG)
        </a>
    </p><br><br>
</footer>

<button id="scrollToTopBtn" class="scroll-to-top-btn" aria-label="Nach oben scrollen">
    <i class="fas fa-arrow-up"></i>
</button>

<script>
    // --- START OF CONSOLIDATED SCRIPT (Original + Language Logic + Debugging) ---
    let allCardsData = [];
    let allCards = [];
    let countdownInterval;

    // --- I18N and Language Switcher Logic (Placed at the top for clarity) ---
    let currentTranslations = {};

    const languageConfig = {
        'de': { name: 'Deutsch', flagImageUrl: 'images/flags/de.svg' },
        'en': { name: 'English', flagImageUrl: 'images/flags/gb.svg' },
        'ar': { name: 'العربية', flagImageUrl: 'images/flags/sa.svg' },
        'tr': { name: 'Türkçe', flagImageUrl: 'images/flags/tr.svg' },
        'pl': { name: 'Polski', flagImageUrl: 'images/flags/pl.svg' },
        'ru': { name: 'Русский', flagImageUrl: 'images/flags/ru.svg' }
    };

    function getTranslation(key, translations) {
        return key.split('.').reduce((obj, k) => (obj && obj[k] !== undefined) ? obj[k] : undefined, translations);
    }

    async function fetchTranslations(langCode) {
        const filePath = `locales/${langCode}.json`;
        try {
            const response = await fetch(filePath);
            if (!response.ok) {
                // console.error(`Error fetching translation file for ${langCode}: ${response.statusText}`);
                if (langCode !== 'de') {
                    // console.warn(`Falling back to German translations.`);
                    return await fetchTranslations('de');
                }
                return {};
            }
            return await response.json();
        } catch (error) {
            // console.error(`Error loading or parsing translation file for ${langCode}:`, error);
            if (langCode !== 'de') {
                // console.warn(`Falling back to German translations due to error.`);
                return await fetchTranslations('de');
            }
            return {};
        }
    }

    // updatePageLanguage will call the i18n-aware updateCountdown

    async function updatePageLanguage(langCode) {
        // console.log(`updatePageLanguage called with: ${langCode}`);
        currentTranslations = await fetchTranslations(langCode) || {};
        document.documentElement.lang = langCode;

        if (langCode === 'ar') {
            document.documentElement.dir = 'rtl';
            document.body.classList.add('rtl-layout');
        } else {
            document.documentElement.dir = 'ltr';
            document.body.classList.remove('rtl-layout');
        }

        const yearSelector = document.getElementById('yearSelector');
        const currentYear = yearSelector ? yearSelector.value : new Date().getFullYear().toString();

        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.dataset.translate;
            let translation = getTranslation(key, currentTranslations);
            if (translation !== undefined) {
                if (element.dataset.translateYearAware !== undefined) {
                    translation = translation.replace('{year}', currentYear);
                }
                element.textContent = translation;
            } else {
                // console.warn(`Translation not found for key: ${key} in lang: ${langCode}`);
            }
        });
        document.querySelectorAll('[data-translate-aria-label]').forEach(element => {
            const key = element.dataset.translateAriaLabel;
            const translation = getTranslation(key, currentTranslations);
            if (translation !== undefined) {
                element.setAttribute('aria-label', translation);
            } else {
                // console.warn(`ARIA label translation not found for key: ${key} in lang: ${langCode}`);
            }
        });

        if (typeof updateCountdown_i18n === "function") updateCountdown_i18n();

        document.querySelectorAll('.calendar-button').forEach(button => {
            const calendarButtonText = getTranslation('card.calendarButton', currentTranslations) || 'Kalender';
            const icon = button.querySelector('i.fa-calendar-plus');
            if (icon) {
                button.innerHTML = `<i class="fas fa-calendar-plus"></i> ${calendarButtonText}`;
            } else {
                button.textContent = calendarButtonText;
            }
        });

        const mainTitleElement = document.getElementById('mainTitle');
        if (mainTitleElement) {
            const mainTitleKey = mainTitleElement.dataset.translate;
            if (mainTitleKey) {
                let titleTranslation = getTranslation(mainTitleKey, currentTranslations);
                if (titleTranslation) {
                    titleTranslation = titleTranslation.replace('{year}', currentYear);
                    mainTitleElement.textContent = titleTranslation;
                }
            }
        }
        const pageTitleKey = 'header.mainTitle';
        document.title = getTranslation(pageTitleKey, currentTranslations)?.replace('{year}', currentYear) || `Ferienplan ${currentYear}`;

        // console.log(`Page language updated to: ${langCode} with year ${currentYear}`);
    }

    function setButtonLanguage(langCode) {
        const languageMenuButton = document.getElementById('language-menu-button');
        const currentLanguageNameSpan = document.getElementById('current-language-name');
        const currentLanguageFlagImage = document.getElementById('current-flag-image');
        const languageMenuButtonText = languageMenuButton ? languageMenuButton.querySelector('span#current-language-name') : null;


        const config = languageConfig[langCode];
        if (config) {
            if (currentLanguageNameSpan) {
                currentLanguageNameSpan.textContent = config.name;
            } else if (languageMenuButtonText) {
                languageMenuButtonText.textContent = langCode.toUpperCase();
            }

            if (currentLanguageFlagImage) {
                currentLanguageFlagImage.src = config.flagImageUrl;
                currentLanguageFlagImage.alt = `Flag of ${config.name}`;
            }
        } else {
            // console.error('setButtonLanguage: Missing config for langCode:', langCode);
            if (languageMenuButtonText) languageMenuButtonText.textContent = "ERR";
        }
    }

    // --- Original Page Logic Functions (adapted for i18n where needed) ---
    function createCardElement(cardData) {
        const card = document.createElement('section');
        card.classList.add('card');
        card.setAttribute('data-start-date', cardData.startDate);
        card.setAttribute('data-end-date', cardData.endDate);
        const title = document.createElement('h2');
        title.classList.add('section-title', 'text-2xl', 'md:text-3xl');
        title.textContent = cardData.title;
        card.appendChild(title);
        const ul = document.createElement('ul');
        ul.classList.add('list-disc', 'pl-5');
        cardData.details.forEach(detail => {
            const li = document.createElement('li');
            li.classList.add('list-item');
            if (detail.isDeadline) {
                li.classList.add('deadline-highlight');
            }
            const span = document.createElement('span');
            span.innerHTML = detail.text.includes('strong>') ? detail.text : `<span>${detail.text}</span>`;
            li.appendChild(span);
            if (detail.icsData) {
                const button = document.createElement('button');
                button.classList.add('calendar-button');
                const calendarButtonText = getTranslation('card.calendarButton', currentTranslations) || 'Kalender';
                button.innerHTML = `<i class="fas fa-calendar-plus"></i> ${calendarButtonText}`;
                button.onclick = () => {
                    downloadICS(
                        detail.icsData.filename,
                        detail.icsData.dtstart,
                        detail.icsData.dtend,
                        detail.icsData.summary,
                        detail.icsData.description
                    );
                };
                li.appendChild(button);
            }
            ul.appendChild(li);
        });
        card.appendChild(ul);
        return card;
    }

    function findNextImportantEvent() {
        const now = new Date();
        let nextEvent = null;
        let minDiff = Infinity;
        for (const card of allCardsData) {
            for (const detail of card.details) {
                if (detail.isDeadline && detail.icsData) {
                    const targetDateString = detail.icsData.dtstart;
                    if (targetDateString) {
                        const year = parseInt(targetDateString.substring(0, 4), 10);
                        const month = parseInt(targetDateString.substring(4, 6), 10) - 1;
                        const day = parseInt(targetDateString.substring(6, 8), 10);
                        const targetDate = new Date(year, month, day);
                        targetDate.setHours(15, 0, 0, 0);
                        if (targetDate.getTime() > now.getTime()) {
                            const diff = targetDate.getTime() - now.getTime();
                            if (diff < minDiff) {
                                minDiff = diff;
                                nextEvent = { name: card.title.replace('ferien', ''), targetDate: targetDate };
                            }
                        }
                    }
                }
            }
        }
        return nextEvent;
    }

    function updateCountdown_i18n() { // Renamed to avoid conflict if old one was somehow still there
        const countdownCombinedDisplay = document.getElementById('countdownCombinedDisplay');
        const stickyCountdownBar = document.getElementById('stickyCountdownBar');
        const nextEvent = findNextImportantEvent();

        if (!countdownCombinedDisplay || !stickyCountdownBar) {
             // console.warn("Countdown display elements not found during updateCountdown_i18n call.");
             if(countdownInterval) clearInterval(countdownInterval);
             return;
        }

        if (!nextEvent) {
            const noEventMsg = getTranslation('countdown.noUpcomingEvent', currentTranslations) || "Kein bevorstehendes Anmeldedatum.";
            countdownCombinedDisplay.textContent = noEventMsg;
            stickyCountdownBar.style.display = 'flex';
            if (countdownInterval) clearInterval(countdownInterval);
            return;
        }

        stickyCountdownBar.style.display = 'flex';
        const now = new Date().getTime();
        const distance = nextEvent.targetDate.getTime() - now;
        const eventNameDisplay = nextEvent.name;

        if (distance < 0) {
            let expiredMsg = getTranslation('countdown.expired', currentTranslations) || "Abgelaufen!";
            let deadlineForMsgPart = getTranslation('countdown.deadlineFor', currentTranslations) || "Anmeldeschluss für {eventName}feriendienst";
            deadlineForMsgPart = deadlineForMsgPart.replace('{eventName}', eventNameDisplay);
            countdownCombinedDisplay.textContent = `${deadlineForMsgPart}: ${expiredMsg}`;
            if (countdownInterval) clearInterval(countdownInterval);
            return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        let timerString = '';
        if (days > 0) {
            timerString += `${days}T `;
        }
        timerString += `${String(hours).padStart(2, '0')}Std ${String(minutes).padStart(2, '0')}Min ${String(seconds).padStart(2, '0')}Sek`;

        countdownCombinedDisplay.textContent = `Anmeldeschluss für ${nextEvent.name}feriendienst in ${timerString}`;
    }


    /**
     * Schaltet den Dark Mode ein und aus.
     * Speichert die Präferenz im localStorage.
     */
    function toggleDarkMode() {
        const body = document.body;
        body.classList.toggle('dark-mode');
        const isDarkMode = body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');

        // Aktualisiert das Button-Icon
        const darkModeToggleIcon = document.querySelector('#darkModeToggle i');
        if (isDarkMode) {
            darkModeToggleIcon.classList.remove('fa-moon');
            darkModeToggleIcon.classList.add('fa-sun');
        } else {
            darkModeToggleIcon.classList.remove('fa-sun');
            darkModeToggleIcon.classList.add('fa-moon');
        }
    }

    /**
     * Schaltet den eingeklappten/ausgeklappten Zustand eines kollabierbaren Abschnitts um.
     * @param {HTMLButtonElement} button Der Button, der den Umschalter ausgelöst hat.
     */
    function toggleCollapsible(button) {
        const targetId = button.dataset.target;
        const content = document.getElementById(targetId);
        const icon = button.querySelector('i');

        const isExpanded = content.classList.contains('expanded');

        if (isExpanded) {
            content.classList.remove('expanded');
            button.classList.remove('expanded');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            button.setAttribute('aria-expanded', 'false');
        } else {
            content.classList.add('expanded');
            button.classList.add('expanded');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            button.setAttribute('aria-expanded', 'true');
        }
    }


    /**
     * Parst einen deutschen Datumsstring (TT.MM.JJJJ oder T[T]. Monatsname) in ein Date-Objekt.
     * Behandelt einzelne Daten oder Datumsbereiche.
     * Gibt das *späteste* Datum in einem Bereich zurück, oder das einzelne Datum.
     * Gibt null zurück, wenn kein gültiges Datum gefunden wird.
     * Diese Funktion wird nun hauptsächlich zum Parsen von Daten innerhalb der 'text'-Eigenschaft von Details verwendet,
     * die möglicherweise nicht immer im strikten YYYY-MM-DD-Format vorliegen.
     */
    function parseGermanDate(dateString) {
        const monthMap = {
            'januar': 0, 'februar': 1, 'märz': 2, 'april': 3, 'mai': 4, 'juni': 5,
            'juli': 6, 'august': 7, 'september': 8, 'oktober': 9, 'november': 10, 'dezember': 11
        };

        let dates = [];

        // Versucht, das Format TT.MM.JJJJ oder T.M.JJJJ abzugleichen
        const regexNumericDate = /(\d{1,2})\.(\d{1,2})\.(\d{4})/;
        let matchNumeric = dateString.match(regexNumericDate);
        if (matchNumeric) {
            const day = parseInt(matchNumeric[1], 10);
            const month = parseInt(matchNumeric[2], 10) - 1; // Monat ist 0-indiziert
            const year = parseInt(matchNumeric[3], 10);
            dates.push(new Date(year, month, day));
        }

        // Versucht, das Format T[T]. Monatsname (z.B. "3. Mai 2025") abzugleichen
        const regexMonthNameDate = /(\d{1,2})\.\s*(Januar|Februar|März|April|Mai|Juni|Juli|August|September|Oktober|November|Dezember)\s*(\d{4})/i;
        let matchMonthName = dateString.match(regexMonthNameDate);
        if (matchMonthName) {
            const day = parseInt(matchMonthName[1], 10);
            const monthName = matchMonthName[2].toLowerCase();
            const month = monthMap[monthName];
            const year = parseInt(matchMonthName[3], 10);
            if (month !== undefined) {
                dates.push(new Date(year, month, day));
            }
        }

        // Versucht, Datumsbereiche (z.B. "03.07. - 13.08.2025") abzugleichen
        const regexDateRange = /(\d{1,2}\.\d{1,2}\.\d{4})\s*-\s*(\d{1,2}\.\d{1,2}\.\d{4})/;
        let matchRange = dateString.match(regexDateRange);
        if (matchRange) {
            const date1 = parseGermanDate(matchRange[1]);
            const date2 = parseGermanDate(matchRange[2]);
            if (date1) dates.push(date1);
            if (date2) dates.push(date2);
        }


        if (dates.length === 0) {
            return null;
        } else if (dates.length === 1) {
            return dates[0];
        } else {
            // Wenn mehrere Daten gefunden werden (z.B. ein Bereich), nimm das späteste Datum für die "Vergangen"-Prüfung.
            return new Date(Math.max(...dates.map(d => d.getTime())));
        }
    }


    /**
     * Generiert und lädt eine ICS-Kalenderdatei herunter.
     * @param {string} filename Der Name der herunterzuladenden Datei (z.B. "Winterferien").
     * @param {string} dtstart Das Startdatum im INSEE-YYYYMMDD-Format (z.B. "20250203").
     * @param {string} dtend Das Enddatum im INSEE-YYYYMMDD-Format. Für ganztägige Ereignisse ist dies der Tag *nach* dem Ende des Ereignisses.
     * @param {string} summary Die Zusammenfassung/der Titel des Ereignisses.
     * @param {string} description Die Beschreibung des Ereignisses.
     * @param {string} [location='Kita'] Der Ort des Ereignisses.
     */
    function downloadICS(filename, dtstart, dtend, summary, description, location = 'Kita') {
        const uid = Date.now().toString(36) + Math.random().toString(36).substr(2); // Eindeutige ID für das Ereignis
        const now = new Date();
        const created = now.toISOString().replace(/[-:]|\.\d{3}/g, '', 'Z'); // Aktueller Zeitstempel im INSEE-YYYYMMDDTHHMMSSZ

        const icsContent = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//Google Inc//Google Calendar 70.9054//EN',
            'CALSCALE:GREGORIAN',
            'BEGIN:VEVENT',
            `DTSTAMP:${created}`,
            `UID:${uid}@ferienplan.kita.de`, // Eindeutige ID für das Ereignis
            `DTSTART;VALUE=DATE:${dtstart}`, // Start des ganztägigen Ereignisses
            `DTEND;VALUE=DATE:${dtend}`,     // Ende des ganztägigen Ereignisses (exklusiv)
            `SUMMARY:${summary}`,
            `DESCRIPTION:${description}`,
            `LOCATION:${location}`,
            'END:VEVENT',
            'END:VCALENDAR'
        ].join('\n');

        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url); // Bereinigt die Objekt-URL
    }

    /**
     * Wendet Filter und Sortierung an und aktualisiert dann die visuelle Hervorhebung.
     */
    function applyFiltersAndSorting() {
        const filterSelect = document.getElementById('filterOptions');
        const sortSelect = document.getElementById('sortOptions');
        const cardsContainer = document.getElementById('cards-container');

        const selectedFilter = filterSelect.value;
        const selectedSort = sortSelect.value;

        // Beginnt mit der vollständigen Menge der ursprünglichen Karten-Elemente
        let displayedCards = [...allCards]; // Erstellt eine flache Kopie

        // 1. Karten filtern
        displayedCards = displayedCards.filter(cardElement => {
            const startDateStr = cardElement.dataset.startDate;
            const endDateStr = cardElement.dataset.endDate;

            if (!startDateStr || !endDateStr) return true;

            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateStr);
            endDate.setHours(0, 0, 0, 0);

            if (selectedFilter === 'upcoming') {
                const today = new Date();
                today.setHours(0,0,0,0);
                return startDate >= today || (startDate <= today && endDate >= today);
            }
            return true;
        });

        // 2. Gefilterte Karten sortieren
        displayedCards.sort((a, b) => {
            const dateA = new Date(a.dataset.startDate);
            const dateB = new Date(b.dataset.startDate);

            if (selectedSort === 'asc') {
                return dateA.getTime() - dateB.getTime();
            } else {
                return dateB.getTime() - dateA.getTime();
            }
        });

        // 3. Sortierte und gefilterte Karten wieder an das DOM anhängen
        cardsContainer.innerHTML = '';
        displayedCards.forEach(card => cardsContainer.appendChild(card));

        // 4. Nach dem Filtern und Sortieren die visuelle Hervorhebung erneut anwenden
        updateVisualHighlighting();
    }

    /**
     * Wendet visuelle Hervorhebung (vergangen, aktuell, kommend) auf Karten und Durchstreichung auf vergangene Listenelemente an.
     * Diese Funktion sollte nach dem Filtern und Sortieren aufgerufen werden.
     */
    function updateVisualHighlighting() {
        const cards = document.querySelectorAll('.card');
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let soonestUpcomingStartDate = Infinity;
        let soonestUpcomingCard = null;

        cards.forEach(card => {
            const startDateStr = card.dataset.startDate;
            const endDateStr = card.dataset.endDate;

            card.classList.remove('past-card', 'current-card', 'upcoming-card');

            if (!startDateStr || !endDateStr) {
                // console.warn('Card missing start or end date:', card);
            } else {
                const startDate = new Date(startDateStr);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(endDateStr);
                endDate.setHours(0, 0, 0, 0);

                if (endDate < today) {
                    card.classList.add('past-card');
                } else if (startDate <= today && endDate >= today) {
                    card.classList.add('current-card');
                } else if (startDate > today) {
                    if (startDate.getTime() < soonestUpcomingStartDate) {
                        soonestUpcomingStartDate = startDate.getTime();
                        soonestUpcomingCard = card;
                    }
                }
            }

            const listItems = card.querySelectorAll('.list-item span, .deadline-highlight span');
            listItems.forEach(spanElement => {
                const dateInItem = parseGermanDate(spanElement.textContent);
                if (dateInItem && dateInItem < today) {
                    spanElement.classList.add('line-through');
                } else {
                    spanElement.classList.remove('line-through');
                }
            });
        });

        if (soonestUpcomingCard) {
            soonestUpcomingCard.classList.add('upcoming-card');
        }
    }

    /**
     * Lädt die Daten für das angegebene Jahr und rendert die Karten neu.
     * Aktualisiert auch den Haupttitel und den Dokumenttitel.
     * @param {number} year Das Jahr, für das die Daten geladen werden sollen.
     */
    async function loadAndRenderData(year) {
        const cardsContainer = document.getElementById('cards-container');
        const mainTitle = document.getElementById('mainTitle');

        // Update main title and document title
        mainTitle.textContent = `Ferienplan ${year}`;
        document.title = `Ferienplan ${year}`;


        // Clear existing cards
        cardsContainer.innerHTML = '';
        allCards.length = 0;
        allCardsData.length = 0;

        // Clear and stop existing countdown
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        document.getElementById('stickyCountdownBar').style.display = 'none'; // Hide until new data is loaded

        try {
            const dataFilePath = `data/${year}.json`; // Relativer Pfad für GitHub Pages
            const response = await fetch(dataFilePath);
            if (!response.ok) {
                // Wenn die Datei nicht gefunden wird, zeigen wir eine Meldung an
                if (response.status === 404) {
                    cardsContainer.innerHTML = `<p class="text-gray-600 text-center text-lg mt-8">Keine Termine für das Jahr ${year} gefunden.</p>`;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            allCardsData = await response.json();

            // Generate HTML elements from fetched data
            allCardsData.forEach(cardData => {
                const cardElement = createCardElement(cardData);
                allCards.push(cardElement); // Store the generated HTML elements
            });

            // Apply filters and sorting initially (this will also trigger visual highlighting)
            applyFiltersAndSorting();

            // Restart countdown for new data
            updateCountdown_i18n();
            countdownInterval = setInterval(updateCountdown_i18n, 1000);

        } catch (error) {
            // console.error(`Fehler beim Laden der Termine für ${year}:`, error);
            // Wenn noch keine Fehlermeldung angezeigt wird, füge eine hinzu
            if (!cardsContainer.querySelector('.text-red-500') && !cardsContainer.querySelector('.text-gray-600')) {
                cardsContainer.innerHTML = '<p class="text-red-500 text-center text-lg">Fehler beim Laden der Termine. Bitte versuchen Sie es später erneut.</p>';
            }
        }
    }

    /**
     * Füllt das Jahresauswahl-Dropdown mit Optionen.
     */
    function populateYearSelector() {
        const yearSelector = document.getElementById('yearSelector');
        const currentYear = new Date().getFullYear();
        const startYear = 2025; // Startjahr für die Auswahl
        const endYear = currentYear + 2; // Aktuelles Jahr + 2 Jahre in die Zukunft

        yearSelector.innerHTML = ''; // Vorhandene Optionen leeren

        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelector.appendChild(option);
        }

        // Das aktuelle Jahr als Standard auswählen
        yearSelector.value = currentYear;
    }


    // --- START LANGUAGE SWITCHER AND TRANSLATION LOGIC ---
    let currentTranslations = {};

    const languageConfig = {
        'de': { name: 'Deutsch', flagImageUrl: 'images/flags/de.svg' },
        'en': { name: 'English', flagImageUrl: 'images/flags/gb.svg' },
        'ar': { name: 'العربية', flagImageUrl: 'images/flags/sa.svg' },
        'tr': { name: 'Türkçe', flagImageUrl: 'images/flags/tr.svg' },
        'pl': { name: 'Polski', flagImageUrl: 'images/flags/pl.svg' },
        'ru': { name: 'Русский', flagImageUrl: 'images/flags/ru.svg' }
    };

    function getTranslation(key, translations) {
        return key.split('.').reduce((obj, k) => (obj && obj[k] !== undefined) ? obj[k] : undefined, translations);
    }

    async function fetchTranslations(langCode) {
        const filePath = `locales/${langCode}.json`;
        try {
            const response = await fetch(filePath);
            if (!response.ok) {
                // console.error(`Error fetching translation file for ${langCode}: ${response.statusText}`);
                if (langCode !== 'de') {
                    // console.warn(`Falling back to German translations.`);
                    return await fetchTranslations('de');
                }
                return null;
            }
            return await response.json();
        } catch (error) {
            // console.error(`Error loading or parsing translation file for ${langCode}:`, error);
            if (langCode !== 'de') {
                // console.warn(`Falling back to German translations due to error.`);
                return await fetchTranslations('de');
            }
            return null;
        }
    }

    async function updatePageLanguage(langCode) {
        // console.log(`updatePageLanguage called with: ${langCode}`);
        currentTranslations = await fetchTranslations(langCode) || {};
        document.documentElement.lang = langCode;

        if (langCode === 'ar') {
            document.documentElement.dir = 'rtl';
            document.body.classList.add('rtl-layout');
        } else {
            document.documentElement.dir = 'ltr';
            document.body.classList.remove('rtl-layout');
        }

        const yearSelector = document.getElementById('yearSelector');
        const currentYear = yearSelector ? yearSelector.value : new Date().getFullYear().toString();

        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.dataset.translate;
            let translation = getTranslation(key, currentTranslations);
            if (translation !== undefined) {
                if (element.dataset.translateYearAware !== undefined) {
                    translation = translation.replace('{year}', currentYear);
                }
                element.textContent = translation;
            } else {
                // console.warn(`Translation not found for key: ${key} in lang: ${langCode}`);
            }
        });
        document.querySelectorAll('[data-translate-aria-label]').forEach(element => {
            const key = element.dataset.translateAriaLabel;
            const translation = getTranslation(key, currentTranslations);
            if (translation !== undefined) {
                element.setAttribute('aria-label', translation);
            } else {
                // console.warn(`ARIA label translation not found for key: ${key} in lang: ${langCode}`);
            }
        });

        updateCountdown_i18n(); // Refresh countdown text with new language
        // If cards are already rendered, their static "Calendar" button text would need re-translation.
        document.querySelectorAll('.calendar-button').forEach(button => {
            const calendarButtonText = getTranslation('card.calendarButton', currentTranslations) || 'Kalender';
            // Preserve the icon, only change text part
            const icon = button.querySelector('i.fa-calendar-plus');
            if (icon) {
                button.innerHTML = `<i class="fas fa-calendar-plus"></i> ${calendarButtonText}`;
            } else { // Fallback if icon not found for some reason
                button.textContent = calendarButtonText;
            }
        });


        // console.log(`Page language updated to: ${langCode} with year ${currentYear}`);
    }

    function setButtonLanguage(langCode) {
        const currentLanguageNameSpan = document.getElementById('current-language-name');
        const currentLanguageFlagImage = document.getElementById('current-flag-image');
        const languageMenuButton = document.getElementById('language-menu-button');
        const languageMenuButtonText = languageMenuButton ? languageMenuButton.querySelector('span#current-language-name') : null;


        const config = languageConfig[langCode];
        if (config) {
            if (currentLanguageNameSpan) {
                currentLanguageNameSpan.textContent = config.name;
            } else if (languageMenuButtonText) {
                languageMenuButtonText.textContent = langCode.toUpperCase();
            }

            if (currentLanguageFlagImage) {
                currentLanguageFlagImage.src = config.flagImageUrl;
                currentLanguageFlagImage.alt = `Flag of ${config.name}`;
            }
        } else {
            // console.error('setButtonLanguage: Missing config for langCode:', langCode);
            if (languageMenuButtonText) languageMenuButtonText.textContent = "ERR";
        }
    }


    // Initial setup when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', async () => {
        // console.log('DOMContentLoaded: Verifying elements for language switcher setup...');
        const languageMenuButton = document.getElementById('language-menu-button');
        const languageMenu = document.getElementById('language-menu');

        if (!languageMenuButton) {
            // console.error('CRITICAL: language-menu-button NOT FOUND in DOM at setup time.');
            return;
        }
        if (!languageMenu) {
            // console.error('CRITICAL: language-menu NOT FOUND in DOM at setup time.');
        }
        // console.log('Language button and menu elements obtained:', languageMenuButton, languageMenu);

        if (languageMenu && !languageMenu.classList.contains('hidden')) {
            // console.warn('Menu was not initially hidden by class. Adding hidden class and setting style.display to none.');
            languageMenu.classList.add('hidden');
            languageMenu.style.display = 'none';
        } else if (languageMenu && languageMenu.classList.contains('hidden') && languageMenu.style.display !== 'none') {
            // console.warn('Menu has hidden class but style.display is not none. Setting style.display = "none".');
            languageMenu.style.display = 'none';
        }

        if (languageMenuButton && languageMenu) {
            // console.log('Attaching event listeners to language switcher.');
            languageMenuButton.addEventListener('click', function (event) {
                // console.log('#language-menu-button clicked!', event);
                event.stopPropagation();

                if (!languageMenu) {
                    // console.error('Language menu element is null in click handler!');
                    return;
                }

                const isExpanded = languageMenuButton.getAttribute('aria-expanded') === 'true';
                const isMenuHiddenByStyle = languageMenu.style.display === 'none' || languageMenu.style.display === '';
                const isMenuHiddenByClass = languageMenu.classList.contains('hidden');

                // console.log('Before toggle: menu style.display:', languageMenu.style.display, 'menu hidden class?', isMenuHiddenByClass, 'aria-expanded?', isExpanded);

                if (isMenuHiddenByStyle || isMenuHiddenByClass) {
                    languageMenu.style.display = 'block';
                    languageMenu.classList.remove('hidden');
                    languageMenuButton.setAttribute('aria-expanded', 'true');
                    // console.log('Tried to show menu. New display:', languageMenu.style.display, 'classList:', languageMenu.classList.toString());
                } else {
                    languageMenu.style.display = 'none';
                    languageMenu.classList.add('hidden');
                    languageMenuButton.setAttribute('aria-expanded', 'false');
                    // console.log('Tried to hide menu. New display:', languageMenu.style.display, 'classList:', languageMenu.classList.toString());
                }

                // console.log('After toggle attempt: menu style.display:', languageMenu.style.display, 'menu hidden class?', languageMenu.classList.contains('hidden'), 'aria-expanded?', languageMenuButton.getAttribute('aria-expanded'));
            });

            document.addEventListener('click', function (event) {
                if (!languageMenuButton || !languageMenu) {
                    // console.error("Document click listener: Button or Menu not found.");
                    return;
                }
                // console.log('Document clicked. Target:', event.target);
                const isClickInsideButton = languageMenuButton.contains(event.target);
                const isClickInsideMenu = languageMenu.contains(event.target);
                const isMenuVisible = !languageMenu.classList.contains('hidden') && languageMenu.style.display === 'block';

                // console.log('Is click inside button?', isClickInsideButton, 'Is click inside menu?', isClickInsideMenu, 'Is menu visible?', isMenuVisible);

                if (!isClickInsideButton && !isClickInsideMenu && isMenuVisible) {
                    // console.log('Closing menu due to outside click.');
                    languageMenu.style.display = 'none';
                    languageMenu.classList.add('hidden');
                    languageMenuButton.setAttribute('aria-expanded', 'false');
                }
            });

            languageMenu.querySelectorAll('a[role="menuitem"]').forEach(item => {
                item.addEventListener('click', (event) => {
                    event.preventDefault();
                    const selectedLangCode = item.dataset.langCode;
                    if (selectedLangCode && languageConfig[selectedLangCode]) {
                        localStorage.setItem('selectedLanguage', selectedLangCode);
                        setButtonLanguage(selectedLangCode);
                        updatePageLanguage(selectedLangCode);
                    }
                    if(languageMenu) {
                        languageMenu.style.display = 'none';
                        languageMenu.classList.add('hidden');
                    }
                    if(languageMenuButton) {
                        languageMenuButton.setAttribute('aria-expanded', 'false');
                    }
                });
            });
        }

        const savedLangCode = localStorage.getItem('selectedLanguage');
        if (savedLangCode && languageConfig[savedLangCode]) {
            setButtonLanguage(savedLangCode);
            await updatePageLanguage(savedLangCode);
        } else {
            const defaultLangCode = 'de';
            localStorage.setItem('selectedLanguage', defaultLangCode);
            setButtonLanguage(defaultLangCode);
            await updatePageLanguage(defaultLangCode);
        }

        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            const darkModeToggleIcon = document.querySelector('#darkModeToggle i');
            if(darkModeToggleIcon) {
                darkModeToggleIcon.classList.remove('fa-moon');
                darkModeToggleIcon.classList.add('fa-sun');
            }
        }

        populateYearSelector();
        const initialYear = document.getElementById('yearSelector').value || new Date().getFullYear();
        await loadAndRenderData(parseInt(initialYear, 10));

        document.getElementById('filterOptions').addEventListener('change', applyFiltersAndSorting);
        document.getElementById('sortOptions').addEventListener('change', applyFiltersAndSorting);
        document.getElementById('yearSelector').addEventListener('change', (event) => {
            const selectedYear = parseInt(event.target.value, 10);
            loadAndRenderData(selectedYear).then(() => {
                 // Re-apply translations which might depend on year or newly loaded data
                updatePageLanguage(localStorage.getItem('selectedLanguage') || 'de');
            });
        });

        const darkModeButton = document.getElementById('darkModeToggle');
        if (darkModeButton) { // Check if button exists before adding listener
            darkModeButton.addEventListener('click', toggleDarkMode);
        }

        document.querySelectorAll('.collapsible-header .toggle-button').forEach(button => {
            const targetId = button.dataset.target;
            const content = document.getElementById(targetId);
            const icon = button.querySelector('i');

            // Ensure initial state is collapsed
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            button.classList.remove('expanded');
            button.setAttribute('aria-expanded', 'false');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');

            button.addEventListener('click', () => toggleCollapsible(button));
        });


        // Scroll to Top Button Logic
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');

        // Show/hide button on scroll
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        });

        // Scroll to top on button click
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    });
</script>
</body>
</html>
